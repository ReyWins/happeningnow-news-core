---
import { CATEGORIES } from "../data/categories";

const { story } = Astro.props;
const floatClass = story.imageFloat === "right" ? "right" : "left";
const storyId = String(story?.id ?? "");
const adapterTag = storyId.startsWith("gdelt:")
  ? "GDELT"
  : storyId.startsWith("newsapi:")
    ? "NEWSAPI.AI"
    : "";
const categoryId =
  CATEGORIES.find((category) => category.label === story?.kicker)?.id ??
  "default";
const fallbackIcon = `/icons/${categoryId}.svg`;
const imageSrc = story.imageUrl || fallbackIcon;
const imagePlaceholder = !story.imageUrl;
---

<article class="story">
  <h2>{story.title}</h2>
  {(story.source || story.publishDate || adapterTag) && (
    <div class="story-meta">
      <span class="meta-label">
        {[story.source, story.publishDate].filter(Boolean).join(" · ")}
      </span>
      {adapterTag && <span class="adapter-tag">{adapterTag}</span>}
    </div>
  )}

  <div class="content">
    <img
      src={imageSrc}
      class={`${floatClass} ${imagePlaceholder ? "placeholder" : ""}`}
      alt=""
      loading="lazy"
      onerror={`if (!this.dataset.fallback) { this.dataset.fallback = "true"; this.src = "${fallbackIcon}"; this.classList.add("placeholder"); }`}
    />
    <p>{story.summary}</p>
  </div>

  {story.pageRef && <div class="page-ref">— {story.pageRef}</div>}
</article>

<style>
.story {
  font-size: 14px;
}

.story h2 {
  font-size: 18px;
  margin: 4px 0 8px;
}

.story-meta {
  margin: 0 0 6px;
  font-size: 11px;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: color-mix(in srgb, var(--muted) 85%, var(--ink) 15%);
  display: inline-flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.story-meta .meta-label:empty {
  display: none;
}

.adapter-tag {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 999px;
  border: 1px solid var(--rule);
  font-size: 9px;
  letter-spacing: 0.12em;
  background: color-mix(in srgb, var(--paper) 92%, var(--ink) 8%);
  color: var(--ink);
}

.story img {
  width: 150px;
  height: 100px;
  object-fit: cover;
  border: 1px solid var(--rule);
  margin: 2px 10px 6px 0;
}

.story img.placeholder {
  object-fit: contain;
  background: color-mix(in srgb, var(--paper) 88%, var(--ink) 4%);
  padding: 8px;
}

.story img.right {
  float: right;
  margin: 2px 0 6px 10px;
}

.story img.left {
  float: left;
}

.story .content::after {
  content: "";
  display: block;
  clear: both;
}

.page-ref {
  font-size: 10px;
  color: var(--muted);
  margin-top: 6px;
}
</style>
