---
import NewspaperLayout from "../layouts/NewspaperLayout.astro";
import Masthead from "../components/Masthead.astro";
import data from "../data/mockNews.json";
import { getKeystaticReader, listBlogSlugs } from "../lib/keystatic";
import { Icon } from "astro-icon/components";

export const prerender = false;

const keystaticReader = await getKeystaticReader();
const slugs = await listBlogSlugs();
const withBody = (
  await Promise.all(
    slugs.map(async (slug) => {
      const entry = await keystaticReader.collections.blog.read(slug);
      if (!entry) return null;
      return {
        slug,
        entry,
        date: entry.date,
        bodyDoc: entry.body ? await entry.body() : null,
      };
    })
  )
).filter(Boolean);
const sorted = withBody
  .slice()
  .sort((a, b) => {
    const aParsed = a.date ? Date.parse(String(a.date)) : Number.NEGATIVE_INFINITY;
    const bParsed = b.date ? Date.parse(String(b.date)) : Number.NEGATIVE_INFINITY;
    const aDate = Number.isNaN(aParsed) ? Number.NEGATIVE_INFINITY : aParsed;
    const bDate = Number.isNaN(bParsed) ? Number.NEGATIVE_INFINITY : bParsed;
    if (aDate !== bDate) return aDate - bDate;
    return a.slug.localeCompare(b.slug);
  })
  .reverse();
const perPage = 3;
const totalPages = Math.max(1, Math.ceil(sorted.length / perPage));
const pageParamRaw = Astro.url.searchParams.get("page");
const parsedPage = pageParamRaw ? Number.parseInt(pageParamRaw, 10) : 1;
const safePage = Number.isFinite(parsedPage) ? parsedPage : 1;
const currentPage = Math.min(Math.max(safePage, 1), totalPages);
const start = (currentPage - 1) * perPage;
const pageEntries = sorted.slice(start, start + perPage);
const hasNav = totalPages > 1;
---

<NewspaperLayout meta={data.meta}>
  <Masthead meta={data.meta} />

  <section class="page">
    <header class="page-header">
      <div class="kicker">Blog</div>
      <h2><Icon name="tabler:subtitles-edit" size="22" /> Notes from the Desk</h2>
      <p>Working notes, experiments, and build updates.</p>
    </header>

    <div class="entries">
      {sorted.length === 0 ? (
        <p>Add entries in Keystatic.</p>
      ) : (
        pageEntries.map(({ slug, entry, bodyDoc }) => {
          const summaryText = entry.summary ?? "";
          const trimmed = summaryText.slice(0, 220);
          const needsMore = summaryText.length > 220 || bodyDoc;
          return (
            <article class="entry-card" key={slug}>
              <a class="card-link" href={`/blog/${slug}`}>
                <div class="entry-meta">
                  {entry.date ? <span class="entry-date">{entry.date}</span> : null}
                  {entry.author ? (
                    <>
                      <span class="dot">•</span>
                      <span class="entry-author">Author: {entry.author}</span>
                    </>
                  ) : null}
                </div>
                <h3 class="entry-title">{entry.title}</h3>
                {entry.image ? (
                  <img
                    class="entry-image"
                    src={entry.image}
                    alt={entry.title}
                    loading="lazy"
                    decoding="async"
                  />
                ) : null}
                {trimmed ? (
                  <p class="summary">
                    {trimmed}
                    {needsMore ? "…" : ""}
                    {needsMore ? <span class="read-more">Read more →</span> : null}
                  </p>
                ) : null}
              </a>
              {entry.tags?.length ? (
                <div class="tags">
                  {entry.tags.map((tag) => (
                    <a class="tag" href={`/blog/tags?tag=${encodeURIComponent(tag)}`} key={tag}>
                      {tag}
                    </a>
                  ))}
                </div>
              ) : null}
            </article>
          );
        })
      )}
    </div>

    {hasNav ? (
      <nav class="pager" aria-label="Blog pagination">
        <a
          class={`pager-btn ${currentPage <= 1 ? "disabled" : ""}`}
          href={`/blog?page=${Math.max(1, currentPage - 1)}`}
        >
          ← Previous
        </a>
        <span class="pager-meta">
          Page {currentPage} of {totalPages}
        </span>
        <a
          class={`pager-btn ${currentPage >= totalPages ? "disabled" : ""}`}
          href={`/blog?page=${Math.min(totalPages, currentPage + 1)}`}
        >
          Next →
        </a>
      </nav>
    ) : null}
  </section>

  <style>
    .page {
      margin-top: 18px;
      border-top: 2px solid var(--ink);
      padding-top: 16px;
    }
    .page-header {
      text-align: center;
      margin-bottom: 16px;
    }
    .kicker {
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
    }
    h2 {
      margin: 8px 0 10px;
      font-size: 28px;
      letter-spacing: 0.08em;
    }
    h3 {
      margin: 10px 0 6px;
      font-size: 16px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    p {
      margin: 0 0 10px;
      line-height: 1.6;
    }
    .entries {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }
    .entry-card {
      border: 1px solid var(--rule);
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
      background: var(--paper);
      overflow: hidden;
      transition: transform 120ms ease, box-shadow 120ms ease;
      display: flex;
      flex-direction: column;
    }
    .entry-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.10);
    }
    .card-link {
      display: block;
      color: inherit;
      text-decoration: none;
      padding: 14px 14px 16px;
    }
    .entry-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    .dot { color: var(--muted); }
    .entry-title {
      margin: 0 0 6px;
      font-size: 18px;
      letter-spacing: 0.03em;
      line-height: 1.3;
    }
    .summary {
      font-size: 14px;
      color: var(--muted);
      margin: 0 0 6px;
      line-height: 1.5;
    }
    .entry-image {
      width: 100%;
      border: 1px solid var(--rule);
      margin: 8px 0 10px;
      display: block;
      border-radius: 6px;
      object-fit: cover;
      aspect-ratio: 16 / 9;
    }
    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      padding: 0 14px 14px;
    }
    .tag {
      border: 1px solid var(--rule);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 10px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      text-decoration: none;
      color: inherit;
      display: inline-flex;
      align-items: center;
      line-height: 1;
      transition: background 120ms ease, color 120ms ease, border-color 120ms ease;
    }
    .tag:hover {
      background: var(--ink);
      color: var(--paper);
      border-color: var(--ink);
    }
    .read-more {
      margin-left: 8px;
      font-size: 12px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--ink);
    }
    .pager {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 18px 0 6px;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .pager-btn {
      padding: 6px 10px;
      border: 1px solid var(--rule);
      border-radius: 20px;
      text-decoration: none;
      color: var(--ink);
      transition: background 120ms ease, color 120ms ease;
    }
    .pager-btn:hover {
      background: var(--rule);
    }
    .pager-btn.disabled {
      pointer-events: none;
      opacity: 0.4;
    }
    ul {
      margin: 0 0 10px 18px;
      padding: 0;
      line-height: 1.6;
    }
  </style>
</NewspaperLayout>
